// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model TgBotSessions {
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  key       String   @id @map("key")
  value     Json     @map("value")

  @@map("tg_bot_sessions")
}

model Users {
  id         Int      @id @default(autoincrement()) @map("id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")
  telegramId Int      @unique @map("telegram_id")
  username   String?  @map("username")
  firstName  String?  @map("first_name")
  lastName   String?  @map("last_name")

  workflowVariantUserParams WorkflowVariantUserParams[] // связь с WorkflowVariantUserParams

  @@map("users")
}

model WorkflowTemplates {
  id              Int                @id @default(autoincrement()) @map("id")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @default(now()) @updatedAt @map("updated_at")
  name            String             @map("name")
  description     String?            @map("description")
  schema          Json               @map("schema")
  WorkflowVariant WorkflowVariants[]

  @@map("workflow_templates")
}

model WorkflowVariants {
  id                 Int      @id @default(autoincrement()) @map("id")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at")
  workflowTemplateId Int      @map("workflow_template_id")
  name               String   @unique @map("name")
  description        String?  @map("description")

  workflowTemplate WorkflowTemplates           @relation(fields: [workflowTemplateId], references: [id])
  userParams       WorkflowVariantUserParams[] // связь с WorkflowVariantUserParams

  params WorkflowVariantParams[] // связь с WorkflowVariantParams
  tags   WorkflowVariantTags[] // связь с WorkflowVariantTags

  @@map("workflow_variants")
}

model WorkflowVariantParams {
  id                Int      @id @default(autoincrement()) @map("id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")
  workflowVariantId Int      @map("workflow_variant_id")
  paramName         String   @map("param_name")
  user              Boolean  @map("user")
  value             Json?    @map("value")
  label             String?  @map("label")
  enum              Json?    @map("enum")
  positionX         Int?     @map("position_x")
  positionY         Int?     @map("position_y")

  workflowVariant WorkflowVariants @relation(fields: [workflowVariantId], references: [id])

  @@unique([workflowVariantId, paramName])
  @@map("workflow_variant_params")
}

model WorkflowVariantUserParams {
  id                Int      @id @default(autoincrement()) @map("id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")
  userId            Int      @map("user_id")
  workflowVariantId Int      @map("workflow_variant_id")
  paramName         String   @map("param_name")
  value             Json?    @map("value")

  workflowVariant WorkflowVariants @relation(fields: [workflowVariantId], references: [id])
  user            Users            @relation(fields: [userId], references: [id])

  @@unique([userId, workflowVariantId, paramName])
  @@map("workflow_variant_user_params")
}

model WorkflowVariantTags {
  createdAt         DateTime @default(now()) @map("created_at")
  workflowVariantId Int      @map("workflow_variant_id")
  tag               String   @map("tag")

  workflowVariant WorkflowVariants @relation(fields: [workflowVariantId], references: [id])

  @@unique([workflowVariantId, tag])
  @@map("workflow_variant_tags")
}

model Models {
  id               Int      @id @default(autoincrement()) @map("id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")
  name             String   @unique @map("name")
  comfyUiDirectory String   @map("comfy_ui_directory")
  comfyUiFileName  String   @map("comfy_ui_file_name")
  label            String   @map("label")
  description      String?  @map("description")
  meta             Json     @default("{}") @map("meta")

  huggingfaceLinks ModelHuggingfaceLinks[]
  civitaiLinks     ModelCivitaiLinks[]
  tags             ModelTags[]

  @@map("models")
}

model ModelHuggingfaceLinks {
  id        Int      @id @default(autoincrement()) @map("id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  modelId   Int      @map("model_id")
  repo      String   @map("repo")
  file      String   @map("file")

  model Models @relation(fields: [modelId], references: [id])

  @@unique([repo, file])
  @@map("model_huggingface_links")
}

model ModelCivitaiLinks {
  id               Int      @id @default(autoincrement()) @map("id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")
  modelId          Int      @map("model_id")
  civitaiId        String   @map("civitai_id")
  civitaiVersionId String   @map("civitai_version_id")

  model Models @relation(fields: [modelId], references: [id])

  @@unique([civitaiId, civitaiVersionId])
  @@map("model_civitai_links")
}

model ModelTags {
  createdAt DateTime @default(now()) @map("created_at")
  modelId   Int      @map("model_id")
  tag       String   @map("tag")

  model Models @relation(fields: [modelId], references: [id])

  @@unique([modelId, tag])
  @@map("model_tags")
}
